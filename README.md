# 1주차 과제
## 주제: TDD로 개발하기
> 일정: 2024년 12월 14일 ~ 20일
---
# 📌 개요
## 1️⃣ 과제 필수 사항
- Nest.js 의 경우 Typescript , Spring 의 경우 Kotlin / Java 중 하나로 작성합니다.
    - 프로젝트에 첨부된 설정 파일은 수정하지 않도록 합니다.
- 테스트 케이스의 작성 및 작성 이유를 주석으로 작성하도록 합니다.
- 프로젝트 내의 주석을 참고하여 필요한 기능을 작성해주세요.
- 분산 환경은 고려하지 않습니다.
- `/point` 패키지 (디렉토리) 내에 `PointService` 기본 기능 작성
- `/database` 패키지의 구현체는 수정하지 않고, 이를 활용해 기능을 구현
- 각 기능에 대한 단위 테스트 작성
> 총 4가지 기본 기능 (포인트 조회, 포인트 충전/사용 내역 조회, 충전, 사용) 을 구현합니다.

## 2️⃣ 과제 상세
`point` 패키지의 TODO 와 테스트코드를 작성해주세요.

**요구 사항**  
포인트 조회, 포인트 충전/사용 내역 조회, 충전, 사용
```
- PATCH  `/point/{id}/charge` : 포인트를 충전한다.
- PATCH `/point/{id}/use` : 포인트를 사용한다.
- GET `/point/{id}` : 포인트를 조회한다.
- GET `/point/{id}/histories` : 포인트 내역을 조회한다.
```
- 잔고가 부족할 경우, 포인트 사용은 실패하여야 합니다.
- 동시에 여러 건의 포인트 충전, 이용 요청이 들어올 경우 순차적으로 처리되어야 합니다.

## 3️⃣ Pass 조건
### ✅ 기본과제
- 포인트 충전, 사용에 대한 정책 추가 (잔고 부족, 최대 잔고 등)
- 동시에 여러 요청이 들어오더라도 순서대로 (혹은 한번에 하나의 요청씩만) 제어될 수 있도록 리팩토링
- 동시성 제어에 대한 통합 테스트 작성
### ✅ 심화과제
- 동시성 제어 방식에 대한 분석 및 보고서 작성 ( **README.md** )

---
# 📌 작업 기록

## 1️⃣ 프로젝트 템플릿 분석 및 요건 정의
### ✅ 테이블
```
+--------------------+       +-----------------------------+
|   UserPointTable   |       |      PointHistoryTable      |
+--------------------+       +-----------------------------+
| PK  id             |<------| FK  userId                  |
|     point          |       | PK  id                      |
|     updateMillis   |       |     amount                  |
+--------------------+       |     type (TransactionType)  |
                             |     updateMillis            |
                             +-----------------------------+
```

### UserPointTable
|컬럼 명|타입|설명|
|---|---|---|
|id|long|사용자 식별 id|
|point|long|해당 사용자의 잔여 point|
|updateMillis|long|업데이트 일자(밀리초 단위, 타임스탬프)|

### PointHistoryTable
|컬럼 명|타입|설명|
|---|---|---|
|id|long|트랜잭션 식별 id|
|userId|long|사용자 식별 id|
|amount|long|포인트 변경 금액|
|type|TransactionType|트랜잭션 유형 (CHARGE - 충전, USE - 사용)|
|updateMillis|long|업데이트 일자(밀리초 단위, 타임스탬프)|

### ✅ 포인트 트랜잭션 종류
| Type   | 설명 |
|--------|----|
| CHARGE | 충전 |
|USE| 사용 |

### ✅ API 명세 및 기능 요구사항
### 포인트 조회
- **Endpoint**
  - GET /{id}
- **Path Parameter**
  - id: (long) 조회할 유저의 ID
- **Response**
  ```json
    {
      "id": 1,
      "point": 1000,
      "updateMillis": 1672531200000
    }
  ```
- **기능 요구사항**
  - id로 특정 user의 포인트 조회
  - user가 존재하지 않을 경우 404 반환
- **고려사항**
  - id가 잘못된 형식(음수, 숫자가 아닌 값 등)일 경우 처리
- **행동분석**
  - 요청: 유저 ID를 받아 해당 유저의 포인트 정보를 반환
  - 동작:
    1. id가 유효한 값인지 확인(Validation)
    2. 유저가 존재하는지 확인(Service)
    3. 유저의 포인트 정보를 반환(Service)
- **테스트 케이스**
  - 성공
    - 유저가 존재하는 경우 올바른 포인트 정보를 반환한다.(Service)
    - id가 유효할 경우 True, 유효하지 않을 경우 False를 반환한다.(Validation)
  - 실패
    - id가 주어지지 않으면 조회를 실패한다. - 검증: id가 없는 경우 Service 호출을 하지 않는다. (Controller)
    - 주어진 id가 유효한 값이 아니면 조회를 실패한다. - 검증: id 검증 validation을 통해 False를 반환받을 경우, 조회 실패. (Service)
    - 유저가 존재하지 않으면 조회를 실패한다. - 검증: 해당 id를가진 User가 있는지 확인 (Service)

### 포인트 충전/사용 내역 조회
- **Endpoint**
    - GET /{id}/histories
- **Path Parameter**
    - id: (long) 조회할 유저의 ID
- **Response**
  ```json
    [
      { 
        "id": 1,
        "userId": 1,
        "amount": 100,
        "updateMillis": 1672531200000,
        "type": "CHARGE"
      },
      { 
        "id": 2,
        "userId": 1,
        "amount": 100,
        "updateMillis": 1672531200000,
        "type": "USE"
      }
    ]
  ```
- **기능 요구사항**
  - 특정 유저의 포인트 내역 조회(충전 및 사용 이력)
  - 내역이 없을 경우 빈 배열 반환
- **고려사항**
  - 데이터 정렬(최신 순), 페이징 처리(템플릿 소스에서는 페이징 관련 내용이 없으므로 제외)
- **행동 분석**
  - 요청: 유저 ID를 받아 해당 유저의 포인트 충전/사용 내역 리스트를 반환
  - 동작
    1. id가 유효한 값인지 확인(Validation)
    2. 유저가 존재하는지 확인(Service)
    3. 유저의 내역이 있으면 반환, 없으면 빈 배열을 반환(Service)
- **테스트 케이스**
  - 성공
    - 유저가 존재하며 내역이 있으면 내역 리스트를 반환한다. (Service)
    - 유저가 존재하지만 내역이 없으면 빈 배열을 반환한다. (Service)
    - id가 유효할 경우 True, 유효하지 않을 경우 False를 반환한다.(Validation)
  - 실패
    - id가 주어지지 않으면 조회를 실패한다. - 검증: id가 없는 경우 Service 호출을 하지 않는다. (Controller)
    - 주어진 id가 유효한 값이 아니면 조회를 실패한다. - 검증: id 검증 validation을 통해 False를 반환받을 경우, 조회 실패. (Service)
    - 유저가 존재하지 않으면 조회를 실패한다. - 검증: 해당 id를가진 User가 있는지 확인 (Service)

### 포인트 충전
- **Endpoint**
    - PATCH /{id}/charge
- **Path Parameter**
    - id: (long) 포인트 충전할 유저의 ID
    - amount: (long) 충전 할 포인트
- **Response**
  ```json
    {
        "id": 1,
        "point": 1500,
        "updateMillis": 1672531500000
    }
  ```
- **기능 요구사항**
  - 요청받은 amount만큼 유저의 포인트를 충전.
  - 충전 금액은 반드시 0보다 커야 함.
- **고려사항**
  - 충전 실패 시 롤백(현재 DB 구현체는 롤백을 제공하지 않음)
  - (추가 범위)최대 잔고 이상 충전 불가
- **행동 분석**
  - 요청: 유저 ID와 충전 금액을 받아 포인트를 충전
  - 동작:
    1. 입력된 id와 amount가 유효한 값인지 확인(Validation)
    2. 유저가 존재할 경우 현재 유저의 포인트 조회, 유저가 존재하지 않을 경우 0 (Service)
    3. 포인트 충전 시 최대 잔고를 넘는지 확인(추가 범위)(Service)
    4. 충전 금액을 포인트에 더한 뒤 UserPointTable 업데이트(Service)
    5. 업데이트된 포인트 정보를 반환(Service)
- **테스트 케이스**
  - 성공
    - 유효한 금액을 입력하면 (충전 후 최대 잔고를 넘지 않으면) 포인트가 정상적으로 충전된다. (Service)
  - 실패
    - id나 amount가 주어지지 않으면 충전을 실패한다. - 검증: id나 amount가 없는 경우 Service 호출을 하지 않는다. (Controller)
    - 주어진 id나 amount가 유효한 값이 아니면 충전을 실패한다. - 검증: id, amount 검증 validation을 통해 False를 반환받을 경우, 충전 실패. (Service)
    - 충전 후 포인트가 최대 잔고를 넘으면 충전을 실패한다.(추가 범위) 검증: 최종 포인트가 최대 잔고를 넘는지 확인 (Service)

### 포인트 사용
- **Endpoint**
    - PATCH /{id}/use
- **Path Parameter**
    - id: (long) 포인트 사용할 유저의 ID
    - amount: (long) 사용 할 포인트
- **Response**
  ```json
    {
        "id": 1,
        "point": 1500,
        "updateMillis": 1672531500000
    }
  ```
- **기능 요구사항**
    - 요청받은 amount만큼 유저의 포인트를 사용.
    - 사용 금액은 반드시 0보다 커야 함.
- **고려사항**
    - 사용 실패 시 롤백(현재 DB 구현체는 롤백을 제공하지 않음)
    - (추가 범위)잔고 이상 사용 불가
- **행동 분석**
    - 요청: 유저 ID와 사용 금액을 받아 포인트 사용
    - 동작:
      1. 입력된 id와 amount가 유효한 값인지 확인(Validation)
      2. 유저가 존재하는지 확인(Service)
      3. 유저의 현재 포인트 조회(Service)
      4. 포인트 사용 금액이 현재 잔고를 넘는지 확인(추가 범위)(Service)
      5. 포인트 차감 후 UserPointTable 업데이트(Service)
      6. 업데이트된 포인트 정보를 반환(Service)
- **테스트 케이스**
  - 성공
    - 유저가 존재하며 충분한 잔액이 있을 경우 포인트가 정상적으로 차감된다 (Service).
  - 실패
    - id나 amount가 주어지지 않으면 충전을 실패한다. - 검증: id나 amount가 없는 경우 Service 호출을 하지 않는다. (Controller)
    - 주어진 id나 amount가 유효한 값이 아니면 충전을 실패한다. - 검증: id, amount 검증 validation을 통해 False를 반환받을 경우, 충전 실패. (Service)
    - 유저가 존재하지 않으면 사용을 실패한다. - 검증: 해당 id를 가진 User가 있는지 확인 (Service)
    - 사용금액이 잔고를 넘으면 사용을 실패한다.(추가 범위) 검증: 사용 포인트가 잔고를 넘는지 확인 (Service)

> **고려사항 요약**  
> - 유저 존재 확인: 포인트 조회, 포인트 이력조회, 포인트 사용  
> - id, amount 유효성: 음수, 숫자가 아닌 경우 유효하지 않음

